/*!     jquery-chat-comments.js 1.3.0
 *
 *     (c) 2017 Joona Tykkyl√§inen, Viima Solutions Oy
 *     jquery-chat-comments may be freely distributed under the MIT license.
 *     For all details and documentation:
 *     http://viima.github.io/jquery-chat-comments/
 */
(function(n){typeof define=="function"&&define.amd?define(["jquery"],n):typeof module=="object"&&module.exports?module.exports=function(t,i){return i===undefined&&(i=typeof window!="undefined"?require("jquery"):require("jquery")(t)),n(i),i}:n(jQuery)})(function(n){var t={$el:null,commentsById:{},usersById:{},dataFetched:!1,currentSortKey:"",options:{},events:{click:"closeDropdowns","keydown [contenteditable]":"saveOnKeydown","focus [contenteditable]":"saveEditableContent","keyup [contenteditable]":"checkEditableContentForChange","paste [contenteditable]":"checkEditableContentForChange","input [contenteditable]":"checkEditableContentForChange","blur [contenteditable]":"checkEditableContentForChange","click .navigation li[data-sort-key]":"navigationElementClicked","click .navigation li.title":"toggleNavigationDropdown","click .chat-commenting-field.main .textarea":"showMainCommentingField","click .chat-commenting-field.main .close":"hideMainCommentingField","click .chat-commenting-field .textarea":"increaseTextareaHeight","change .chat-commenting-field .textarea":"increaseTextareaHeight textareaContentChanged","click .chat-commenting-field:not(.main) .close":"removeCommentingField","click .chat-commenting-field .send.enabled":"postComment","click .chat-commenting-field .update.enabled":"putComment","click .chat-commenting-field .delete.enabled":"deleteComment",'change .chat-commenting-field .upload.enabled input[type="file"]':"fileInputChanged","click li.chat-comment button.upvote":"upvoteComment","click li.chat-comment button.delete.enabled":"deleteComment","click li.chat-comment .hashtag":"hashtagClicked","click li.chat-comment .ping":"pingClicked","click li.chat-comment ul.chat-child-comments .toggle-all":"toggleReplies","click li.chat-comment button.reply":"replyButtonClicked","click li.chat-comment button.edit":"editButtonClicked",dragenter:"showDroppableOverlay","dragenter .droppable-overlay":"handleDragEnter","dragleave .droppable-overlay":"handleDragLeaveForOverlay","dragenter .droppable-overlay .droppable":"handleDragEnter","dragleave .droppable-overlay .droppable":"handleDragLeaveForDroppable","dragover .droppable-overlay":"handleDragOverForOverlay","drop .droppable-overlay":"handleDrop","click .dropdown.autocomplete":"stopPropagation","mousedown .dropdown.autocomplete":"stopPropagation","touchstart .dropdown.autocomplete":"stopPropagation"},getDefaultOptions:function(){return{rootUrl:"",profilePictureURL:"",currentUserIsAdmin:!1,currentUserId:null,commentCount:0,commentProfilePicturePath:"",spinnerIconURL:"",upvoteIconURL:"",replyIconURL:"",uploadIconURL:"",attachmentIconURL:"",fileIconURL:"",noCommentsIconURL:"",enableCommentingField:!0,textareaPlaceholderText:"Add a comment",newestText:"Newest",oldestText:"Oldest",popularText:"Popular",attachmentsText:"Attachments",sendText:"Send",replyText:"Reply",editText:"Edit",editedText:"Edited",youText:"You",saveText:"Save",deleteText:"Delete",newText:"New",viewAllRepliesText:"View all __replyCount__ replies",hideRepliesText:"Hide replies",noCommentsText:"No comments",noAttachmentsText:"No attachments",attachmentDropText:"Drop files here",textFormatter:function(n){return n},enableReplying:!1,enableEditing:!1,enableUpvoting:!1,enableDeleting:!1,enableAttachments:!0,enableHashtags:!1,enablePinging:!1,enableDeletingCommentWithReplies:!1,enableNavigation:!0,postCommentOnEnter:!0,forceResponsive:!0,readOnly:!1,defaultNavigationSortKey:"newest",filePath:null,highlightColor:"#2793e6",deleteButtonColor:"#C9302C",scrollContainer:this.$el,roundProfilePictures:!0,textareaRows:2,textareaRowsOnFocus:2,textareaMaxRows:5,maxRepliesVisible:2,fieldMappings:{id:"id",parent:"parent",created:"created",modified:"modified",content:"content",file:"file",fileURL:"file_url",fileMimeType:"file_mime_type",pings:"pings",creator:"creator",fullname:"fullname",profileURL:"profile_url",profilePictureURL:"profile_picture_url",isNew:"is_new",createdByAdmin:"created_by_admin",createdByCurrentUser:"created_by_current_user",upvoteCount:"upvote_count",userHasUpvoted:"user_has_upvoted"},getUsers:function(n){n([])},getComments:function(n){n([])},downloadAttachment:function(){},loadMoreComments:function(){},postComment:function(n,t){t(n)},putComment:function(n,t){t(n)},deleteComment:function(n,t){t()},upvoteComment:function(n,t){t(n)},hashtagClicked:function(){},pingClicked:function(){},uploadAttachments:function(n,t){t(n)},refresh:function(){},timeFormatter:function(n){return new Date(n).toLocaleDateString()}}},init:function(t,i){this.$el=n(i);this.$el.addClass("jquery-chat-comments");this.undelegateEvents();this.delegateEvents(),function(n){(jQuery.browser=jQuery.browser||{}).mobile=/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(n)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(n.substr(0,4))}(navigator.userAgent||navigator.vendor||window.opera);n.browser.mobile&&this.$el.addClass("mobile");this.options=n.extend(!0,{},this.getDefaultOptions(),t);this.options.readOnly&&this.$el.addClass("read-only");this.currentSortKey=this.options.defaultNavigationSortKey;this.createCssDeclarations();this.fetchDataAndRender();var r=this;n(n(i).selector).scroll(function(){n(n(i).selector).scrollTop()-150<=n(n(i).selector).height()-n(n(i).selector).height()&&r.options.loadMoreComments(r)});n(function(){window.emojiPicker=new EmojiPicker({emojiable_selector:"[data-emojiable=true]",assetsPath:r.options.rootUrl+"/lib/emoji-picker/img/",popupButtonClasses:"fa fa-smile-o"});window.emojiPicker.discover()})},delegateEvents:function(){this.bindEvents(!1)},undelegateEvents:function(){this.bindEvents(!0)},bindEvents:function(t){var e=t?"off":"on",r,f,i;for(r in this.events){var o=r.split(" ")[0],s=r.split(" ").slice(1).join(" "),u=this.events[r].split(" ");for(f in u)u.hasOwnProperty(f)&&(i=this[u[f]],i=n.proxy(i,this),s==""?this.$el[e](o,i):this.$el[e](o,s,i))}},fetchDataAndRender:function(){var t=this,i,r,u;this.commentsById={};this.usersById={};this.$el.empty();this.createHTML();i=this.after(this.options.enablePinging?2:1,function(){t.dataFetched=!0;t.render()});r=function(r){var u=r.map(function(n){return t.createCommentModel(n)});t.sortComments(u,"oldest");n(u).each(function(n,i){t.addCommentToDataModel(i)});i()};this.options.getComments(r,i);this.options.enablePinging&&(u=function(r){n(r).each(function(n,i){t.usersById[i.id]=i});i()},this.options.getUsers(u,i))},fetchNext:function(){var u=this,t=this.createSpinner(),i,r;this.$el.find("ul#comment-list").append(t);i=function(i){n(i).each(function(n,t){u.createComment(t)});t.remove()};r=function(){t.remove()};this.options.getComments(i,r)},createCommentModel:function(n){var t=this.applyInternalMappings(n);return t.childs=[],t},addCommentToDataModel:function(n){if(!(n.id in this.commentsById)&&(this.commentsById[n.id]=n,n.parent)){var t=this.getOutermostParent(n.parent);t.childs.push(n.id)}},updateCommentModel:function(t){n.extend(this.commentsById[t.id],t)},render:function(){var n=this;this.dataFetched&&(this.showActiveContainer(),this.createComments(),this.options.enableAttachments&&this.createAttachments(),this.$el.find("> .spinner").remove(),this.options.refresh())},showActiveContainer:function(){var t=this.$el.find(".navigation li[data-container-name].active"),i=t.data("container-name"),n=this.$el.find('[data-container="'+i+'"]');n.siblings("[data-container]").hide();n.show()},createComments:function(){var i=this;this.$el.find("#comment-list").remove();var r=n("<ul/>",{id:"comment-list","class":"main"}),t=[],u=[];n(this.getComments()).each(function(n,r){r.parent==null?(i.options.commentCount++,t.push(r)):u.push(r)});this.sortComments(t,this.currentSortKey);t.reverse();n(t).each(function(n,t){i.addComment(t,r)});this.sortComments(u,"oldest");n(u).each(function(n,t){i.addComment(t,r)});this.$el.find('[data-container="comments"]').prepend(r)},createAttachments:function(){var r=this,i,t;this.$el.find("#attachment-list").remove();i=n("<ul/>",{id:"attachment-list","class":"main"});t=this.getAttachments();this.sortComments(t,"newest");t.reverse();n(t).each(function(n,t){r.addAttachment(t,i)});this.$el.find('[data-container="attachments"]').prepend(i)},appendNewComment:function(n){var t=this,i=t.createCommentModel(n);t.addCommentToDataModel(i);t.appendComment(i)},prependNewComment:function(n){var t=this,i=t.createCommentModel(n);t.addCommentToDataModel(i);t.prependComment(i)},prependComment:function(n,t){var r,u,i,f,e;t=t||this.$el.find("#comment-list");r=this.createCommentElement(n);n.parent?(u=t.find('.chat-comment[data-id="'+n.parent+'"]'),this.reRenderCommentActionBar(n.parent),i=u.parents(".chat-comment").last(),i.length==0&&(i=u),f=i.find(".chat-child-comments"),e=f.find(".chat-commenting-field"),e.length?e.before(r):f.append(r),this.updateToggleAllButton(i)):(this.options.commentCount++,t.prepend(r))},appendComment:function(n,t){var r,u,i,f,e;t=t||this.$el.find("#comment-list");r=this.createCommentElement(n);n.parent?(u=t.find('.chat-comment[data-id="'+n.parent+'"]'),this.reRenderCommentActionBar(n.parent),i=u.parents(".chat-comment").last(),i.length==0&&(i=u),f=i.find(".chat-child-comments"),e=f.find(".chat-commenting-field"),e.length?e.before(r):f.append(r),this.updateToggleAllButton(i)):(this.options.commentCount++,t.append(r))},addComment:function(n,t){var r,u,i,f,e;t=t||this.$el.find("#comment-list");r=this.createCommentElement(n);n.parent?(u=t.find('.chat-comment[data-id="'+n.parent+'"]'),this.reRenderCommentActionBar(n.parent),i=u.parents(".chat-comment").last(),i.length==0&&(i=u),f=i.find(".chat-child-comments"),e=f.find(".chat-commenting-field"),e.length?e.before(r):f.append(r),this.updateToggleAllButton(i)):t.append(r)},addAttachment:function(n,t){t=t||this.$el.find("#attachment-list");var i=this.createCommentElement(n);t.prepend(i)},removeComment:function(t){var o=this,i=this.commentsById[t],s=this.getChildComments(i.id),r,f,u,e;n(s).each(function(n,t){o.removeComment(t.id)});i.parent&&(r=this.getOutermostParent(i.parent),f=r.childs.indexOf(i.id),r.childs.splice(f,1));delete this.commentsById[t];u=this.$el.find('li.chat-comment[data-id="'+t+'"]');e=u.parents("li.chat-comment").last();u.remove();this.updateToggleAllButton(e)},uploadAttachments:function(t,i){var r=this,e,o,u;i||(i=this.$el.find(".chat-commenting-field.main"));var f=i.find(".upload"),c=!i.hasClass("main"),s=t.length;if(s){e=i.find(".textarea");f.removeClass("enabled");o=this.createSpinner();u=this.createSpinner();this.$el.find("ul#attachment-list").prepend(o);c?i.before(u):this.$el.find("ul#comment-list").prepend(u);var l=function(t){n(t).each(function(n,t){var i=r.createCommentModel(t);r.addCommentToDataModel(i);r.addComment(i);r.addAttachment(i)});t.length==s&&r.getTextareaContent(e).length==0&&i.find(".close").trigger("click");f.addClass("enabled");u.remove();o.remove()},a=function(){f.addClass("enabled");u.remove();o.remove()},h=[];n(t).each(function(n,t){var i=r.createCommentJSON(e);i.id+="-"+n;i.file=t;i.fileURL=t.name;i.fileMimeType=t.type;i=r.applyExternalMappings(i);h.push(i)});r.options.uploadAttachments(h,l,a);e.text("")}f.find("input").val("")},updateToggleAllButton:function(t){var f,e,o;if(this.options.maxRepliesVisible!=null){var u=t.find(".chat-child-comments"),r=u.find(".chat-comment"),i=u.find("li.toggle-all");r.removeClass("hidden-reply");f=this.options.maxRepliesVisible===0?r:r.slice(0,-this.options.maxRepliesVisible);f.addClass("hidden-reply");i.find("span.text").text()==this.options.textFormatter(this.options.hideRepliesText)&&f.addClass("visible");r.length>this.options.maxRepliesVisible?(i.length||(i=n("<li/>",{"class":"toggle-all highlight-font-bold"}),e=n("<span/>",{"class":"text"}),o=n("<span/>",{"class":"caret"}),i.append(e).append(o),u.prepend(i)),this.setToggleAllButtonText(i,!1)):i.remove()}},sortComments:function(n,t){var i=this;t=="popularity"?n.sort(function(n,t){var r=n.childs.length,u=t.childs.length,f,e;return i.options.enableUpvoting&&(r+=n.upvoteCount,u+=t.upvoteCount),u!=r?u-r:(f=new Date(n.created).getTime(),e=new Date(t.created).getTime(),e-f)}):n.sort(function(n,i){var r=new Date(n.created).getTime(),u=new Date(i.created).getTime();return t=="oldest"?r-u:u-r})},sortAndReArrangeComments:function(t){var i=this.$el.find("#comment-list"),r=this.getComments().filter(function(n){return!n.parent});this.sortComments(r,t);n(r).each(function(n,t){var r=i.find("> li.chat-comment[data-id="+t.id+"]");i.append(r)})},showActiveSort:function(){var t=this.$el.find('.navigation li[data-sort-key="'+this.currentSortKey+'"]'),n,i;this.$el.find(".navigation li").removeClass("active");t.addClass("active");n=this.$el.find(".navigation .title");this.currentSortKey!="attachments"?(n.addClass("active"),n.find("header").html(t.first().html())):(i=this.$el.find(".navigation ul.dropdown").children().first(),n.find("header").html(i.html()));this.showActiveContainer()},forceResponsive:function(){this.$el.addClass("responsive")},closeDropdowns:function(){this.$el.find(".dropdown").hide()},saveOnKeydown:function(t){var i,r;t.keyCode==13&&(i=t.metaKey||t.ctrlKey,(this.options.postCommentOnEnter||i)&&(r=n(t.currentTarget),r.siblings(".control-row").find(".save").trigger("click"),t.stopPropagation(),t.preventDefault()))},saveEditableContent:function(t){var i=n(t.currentTarget);i.data("before",i.html())},checkEditableContentForChange:function(t){var i=n(t.currentTarget);n(i[0].childNodes).each(function(){this.nodeType==Node.TEXT_NODE&&this.length==0&&this.removeNode&&this.removeNode()});i.data("before")!=i.html()&&(i.data("before",i.html()),i.trigger("change"))},navigationElementClicked:function(t){var r=n(t.currentTarget),i=r.data().sortKey;i!="attachments"&&this.sortAndReArrangeComments(i);this.currentSortKey=i;this.showActiveSort()},toggleNavigationDropdown:function(t){t.stopPropagation();var i=n(t.currentTarget).find("~ .dropdown");i.toggle()},showMainCommentingField:function(t){var i=n(t.currentTarget);i.siblings(".control-row").show();i.parent().find(".close").hide();i.parent().find(".upload.inline-button").show();i.focus()},hideMainCommentingField:function(){},increaseTextareaHeight:function(t){var i=n(t.currentTarget);this.adjustTextareaHeight(i,!0)},textareaContentChanged:function(t){var i=n(t.currentTarget),h=i.siblings(".control-row").find(".save"),r,f,u,e,o,s,c,l,a;i.find(".reply-to.tag").length||(r=i.attr("data-comment"),r?(f=i.parents("li.chat-comment"),f.length>1&&(u=f.last().data("id"),i.attr("data-parent",u))):(u=i.parents("li.chat-comment").last().data("id"),i.attr("data-parent",u)));e=i.parents(".chat-commenting-field").first();i[0].scrollHeight>i.outerHeight()?e.addClass("scrollable"):e.removeClass("scrollable");o=!0;s=this.getTextareaContent(i,!0);(r=i.attr("data-comment"))&&(c=s!=this.commentsById[r].content,this.commentsById[r].parent&&(l=this.commentsById[r].parent.toString()),a=i.attr("data-parent")!=l,o=c||a);s.length&&o?h.addClass("enabled"):h.removeClass("enabled")},removeCommentingField:function(t){var i=n(t.currentTarget),u=i.siblings(".textarea"),r;u.attr("data-comment")&&i.parents("li.chat-comment").first().removeClass("edit");r=i.parents(".chat-commenting-field").first();r.remove()},postComment:function(t){var s=this,r=n(t.currentTarget),f=r.parents(".chat-commenting-field").first(),u=f.find(".textarea"),i,e,o;r.removeClass("enabled");i=this.createCommentJSON(u);i=this.applyExternalMappings(i);e=function(n){s.createComment(n);f.find(".close").trigger("click")};o=function(){r.addClass("enabled")};this.options.postComment(i,e,o);u.text("");u.focus()},createComment:function(n){var t=this.createCommentModel(n);this.addCommentToDataModel(t);this.addComment(t)},putComment:function(t){var u=this,f=n(t.currentTarget),e=f.parents(".chat-commenting-field").first(),r=e.find(".textarea"),i,o,s;f.removeClass("enabled");i=n.extend({},this.commentsById[r.attr("data-comment")]);n.extend(i,{parent:r.attr("data-parent")||null,content:this.getTextareaContent(r),pings:this.getPings(r),modified:(new Date).getTime()});i=this.applyExternalMappings(i);o=function(n){var t=u.createCommentModel(n);delete t.childs;u.updateCommentModel(t);e.find(".close").trigger("click");u.reRenderComment(t.id)};s=function(){f.addClass("enabled")};this.options.putComment(i,o,s)},deleteComment:function(t){var e,o;if(confirm("Are you sure to do this action?")){var u=this,r=n(t.currentTarget),s=r.parents(".chat-comment").first(),i=n.extend({},this.commentsById[s.attr("data-id")]),h=i.id,f=i.parent;r.removeClass("enabled");i=this.applyExternalMappings(i);e=function(){u.removeComment(h);f&&u.reRenderCommentActionBar(f)};o=function(){r.addClass("enabled")};this.options.deleteComment(i,e,o)}},hashtagClicked:function(t){var i=n(t.currentTarget),r=i.attr("data-value");this.options.hashtagClicked(r)},pingClicked:function(t){var i=n(t.currentTarget),r=i.attr("data-value");this.options.pingClicked(r)},fileInputChanged:function(t,i){var i=t.currentTarget.files,r=n(t.currentTarget).parents(".chat-commenting-field").first();this.uploadAttachments(i,r)},upvoteComment:function(t){var r=this,h=n(t.currentTarget).parents("li.chat-comment").first(),i=h.data().model,f=i.upvoteCount,e,u,o,s;e=i.userHasUpvoted?f-1:f+1;i.userHasUpvoted=!i.userHasUpvoted;i.upvoteCount=e;this.reRenderUpvotes(i.id);u=n.extend({},i);u=this.applyExternalMappings(u);o=function(n){var t=r.createCommentModel(n);r.updateCommentModel(t);r.reRenderUpvotes(t.id)};s=function(){i.userHasUpvoted=!i.userHasUpvoted;i.upvoteCount=f;r.reRenderUpvotes(i.id)};this.options.upvoteComment(u,o,s)},toggleReplies:function(t){var i=n(t.currentTarget);i.siblings(".hidden-reply").toggleClass("visible");this.setToggleAllButtonText(i,!0)},replyButtonClicked:function(t){var u=n(t.currentTarget),f=u.parents("li.chat-comment").last(),e=u.parents(".chat-comment").first().data().id,i=f.find(".chat-child-comments > .chat-commenting-field"),o,s,l;if(i.length&&i.remove(),o=i.find(".textarea").attr("data-parent"),o!=e){i=this.createCommentingFieldElement(e);f.find(".chat-child-comments").append(i);s=i.find(".textarea");this.moveCursorToEnd(s);var r=this.options.scrollContainer.scrollTop(),h=r+i.position().top+i.outerHeight(),c=r+this.options.scrollContainer.outerHeight();h>c&&(l=r+(h-c),this.options.scrollContainer.scrollTop(l))}},editButtonClicked:function(t){var e=n(t.currentTarget),u=e.parents("li.chat-comment").first(),i=u.data().model,f,r;u.addClass("edit");f=this.createCommentingFieldElement(i.parent,i.id);u.find(".chat-comment-wrapper").first().append(f);r=f.find(".textarea");r.attr("data-comment",i.id);r.append(this.getFormattedCommentContent(i,!0));this.moveCursorToEnd(r)},showDroppableOverlay:function(){this.options.enableAttachments&&(this.$el.find(".droppable-overlay").css("top",this.$el[0].scrollTop),this.$el.find(".droppable-overlay").show(),this.$el.addClass("drag-ongoing"))},handleDragEnter:function(t){var i=n(t.currentTarget).data("dnd-count")||0;i++;n(t.currentTarget).data("dnd-count",i);n(t.currentTarget).addClass("drag-over")},handleDragLeave:function(t,i){var r=n(t.currentTarget).data("dnd-count");r--;n(t.currentTarget).data("dnd-count",r);r==0&&(n(t.currentTarget).removeClass("drag-over"),i&&i())},handleDragLeaveForOverlay:function(n){var t=this;this.handleDragLeave(n,function(){t.hideDroppableOverlay()})},handleDragLeaveForDroppable:function(n){this.handleDragLeave(n)},handleDragOverForOverlay:function(n){n.stopPropagation();n.preventDefault();n.originalEvent.dataTransfer.dropEffect="copy"},hideDroppableOverlay:function(){this.$el.find(".droppable-overlay").hide();this.$el.removeClass("drag-ongoing")},handleDrop:function(t){t.preventDefault();n(t.target).trigger("dragleave");this.hideDroppableOverlay();this.uploadAttachments(t.originalEvent.dataTransfer.files)},stopPropagation:function(n){n.stopPropagation()},createHTML:function(){var p=this,r=this.createMainCommentingFieldElement(),v=r.find(".control-row"),c,u,f,t,e,o,i,a;if(v.hide(),r.find(".close").hide(),this.options.enableNavigation&&(this.$el.append(this.createNavigationElement()),this.showActiveSort()),c=this.createSpinner(),this.$el.append(c),u=n("<div/>",{"class":"data-container","data-container":"comments"}),this.$el.append(u),f=n("<div/>",{"class":"no-comments no-data",text:this.options.textFormatter(this.options.noCommentsText)}),t=n("<i/>",{"class":"fa fa-comments fa-2x"}),this.options.noCommentsIconURL.length&&(t.css("background-image",'url("'+this.options.noCommentsIconURL+'")'),t.addClass("image")),f.prepend(n("<br/>")).prepend(t),u.append(f),this.options.enableAttachments){e=n("<div/>",{"class":"data-container","data-container":"attachments"});this.$el.append(e);o=n("<div/>",{"class":"no-attachments no-data",text:this.options.textFormatter(this.options.noAttachmentsText)});i=n("<i/>",{"class":"fa fa-paperclip fa-2x"});this.options.attachmentIconURL.length&&(i.css("background-image",'url("'+this.options.attachmentIconURL+'")'),i.addClass("image"));o.prepend(n("<br/>")).prepend(i);e.append(o);var l=n("<div/>",{"class":"droppable-overlay"}),y=n("<div/>",{"class":"droppable-container"}),s=n("<div/>",{"class":"droppable"}),h=n("<i/>",{"class":"fa fa-paperclip fa-4x"});this.options.uploadIconURL.length&&(h.css("background-image",'url("'+this.options.uploadIconURL+'")'),h.addClass("image"));a=n("<div/>",{text:this.options.textFormatter(this.options.attachmentDropText)});s.append(h);s.append(a);l.html(y.html(s)).hide();this.$el.append(l)}this.$el.append(r)},createProfilePictureElement:function(t,i){var r;return r=i?n("<div/>").css({"background-image":"url("+this.options.commentProfilePicturePath+i+")"}):n("<i/>",{"class":"fa fa-user"}),r.addClass("profile-picture"),r.attr("data-user-id",i),this.options.roundProfilePictures&&r.addClass("round"),r},createMainCommentingFieldElement:function(){return this.createCommentingFieldElement(undefined,undefined,!0)},createCommentingFieldElement:function(t,i,r){var u=this,o=n("<div/>",{"class":"chat-commenting-field"}),h,c,w,v,a,k,d,e,g,nt;!this.options.enableCommentingField&&r&&o.css("display","none");r&&o.addClass("main");i?(h=this.commentsById[i].profilePictureURL,c=this.commentsById[i].creator):(h=this.options.profilePictureURL,c=this.options.creator);var tt=this.createProfilePictureElement(h,c),l=n("<div/>",{"class":"textarea-wrapper"}),s=n("<div/>",{"class":"control-row"}),f=n("<div/>",{"class":"textarea","data-placeholder":this.options.textFormatter(this.options.textareaPlaceholderText),contenteditable:!0,"data-emojiable":!0,"data-emoji-input":"unicode"});if(this.adjustTextareaHeight(f,!1),w=n("<span/>",{"class":"close inline-button"}).append(n('<span class="left"/>')).append(n('<span class="right"/>')),i)a=this.options.textFormatter(this.options.saveText),v=n("<span/>",{"class":"delete",text:this.options.textFormatter(this.options.deleteText)}).css("background-color",this.options.deleteButtonColor),s.append(v),this.isAllowedToDelete(i)&&v.addClass("enabled");else if(a=this.options.textFormatter(this.options.sendText),this.options.enableAttachments){var y=n("<span/>",{"class":"enabled upload"}),p=n("<i/>",{"class":"fa fa-paperclip"}),b=n("<input/>",{type:"file","data-role":"none"});n.browser.mobile||b.attr("multiple","multiple");this.options.uploadIconURL.length&&(p.css("background-image",'url("'+this.options.uploadIconURL+'")'),p.addClass("image"));y.append(p).append(b);s.append(y.clone());r&&l.append(y.clone().addClass("inline-button"))}return k=i?"update":"send",d=n("<span/>",{"class":k+" save highlight-background",text:a}),s.prepend(d),l.append(w).append(f).append(s),o.append(tt).append(l),t&&(f.attr("data-parent",t),e=this.commentsById[t],e.parent&&(f.html("&nbsp;"),g="@"+e.fullname,nt=this.createTagElement(g,"reply-to",e.creator,{"data-user-id":e.creator}),f.prepend(nt))),this.options.enablePinging&&(f.textcomplete([{match:/(^|\s)@([^@]*)$/i,index:2,search:function(t,i){var o,e,r;t=u.normalizeSpaces(t);o=u.getPings(f);e=u.getUsers().filter(function(n){var t=n.id==u.options.currentUserId,i=o.indexOf(n.id)!=-1;return!t&&!i});t.length==0?(r=e,r.sort(function(n,t){var i=n.fullname.toLowerCase().trim(),r=t.fullname.toLowerCase().trim();return i<r?-1:i>r?1:0})):(r=n.map(e,function(i){var f,r,u;return i.points=0,f=t.split(" "),r=i.fullname.split(" "),r.splice(1,0,r.splice(r.length-1,1)[0]),u=!0,n(f).each(function(t,f){var e=f.toLowerCase().trim(),o=!1;n(r).each(function(n,t){var r=t.toLowerCase().trim(),u;r.indexOf(e)==0&&(o=!0,u=n==0?.5:n==1?.4:.1,i.points+=e.length/r.length*u)});o||(u=!1)}),u?i:null}),r.sort(function(n,t){return t.points-n.points}));i(r)},template:function(t){var r=n("<div/>"),e=u.createProfilePictureElement(t.profile_picture_url),i=n("<div/>",{"class":"details"}),f=n("<div/>",{"class":"name"}).html(t.fullname),o=n("<div/>",{"class":"email"}).html(t.email);return t.email?i.append(f).append(o):(i.addClass("no-email"),i.append(f)),r.append(e).append(i),r.html()},replace:function(n){var t=u.createTagElement("@"+n.fullname,"ping",n.id,{"data-user-id":n.id});return" "+t[0].outerHTML+" "}}],{appendTo:".jquery-chat-comments",dropdownClassName:"dropdown autocomplete",maxCount:5,rightEdgeOffset:0}),n.fn.textcomplete.Dropdown.prototype.render=function(t){var f=this._buildContents(t),i=n.map(t,function(n){return n.value}),r,e,o,s,h;t.length?(r=t[0].strategy,r.id?this.$el.attr("data-strategy",r.id):this.$el.removeAttr("data-strategy"),this._renderHeader(i),this._renderFooter(i),f&&(this._renderContents(f),this._fitToBottom(),this._fitToRight(),this._activateIndexedItem()),this._setScroll()):this.noResultsMessage?this._renderNoResultsMessage(i):this.shown&&this.deactivate();e=parseInt(this.$el.css("top"))+u.options.scrollContainer.scrollTop();this.$el.css("top",e);o=this.$el.css("left");this.$el.css("left",0);s=u.$el.width()-this.$el.outerWidth();h=Math.min(s,parseInt(o));this.$el.css("left",h)}),o},createNavigationElement:function(){var r=n("<ul/>",{"class":"navigation"}),t=n("<div/>",{"class":"navigation-wrapper"});r.append(t);var o=n("<li/>",{text:this.options.textFormatter(this.options.newestText),"data-sort-key":"newest","data-container-name":"comments"}),s=n("<li/>",{text:this.options.textFormatter(this.options.oldestText),"data-sort-key":"oldest","data-container-name":"comments"}),h=n("<li/>",{text:this.options.textFormatter(this.options.popularText),"data-sort-key":"popularity","data-container-name":"comments"}),u=n("<li/>",{text:this.options.textFormatter(this.options.attachmentsText),"data-sort-key":"attachments","data-container-name":"attachments"}),f=n("<i/>",{"class":"fa fa-paperclip"});this.options.attachmentIconURL.length&&(f.css("background-image",'url("'+this.options.attachmentIconURL+'")'),f.addClass("image"));u.prepend(f);var i=n("<div/>",{"class":"navigation-wrapper responsive"}),e=n("<ul/>",{"class":"dropdown"}),c=n("<li/>",{"class":"title"}),l=n("<header/>");return c.append(l),i.append(c),i.append(e),r.append(i),t.append(o).append(s),e.append(o.clone()).append(s.clone()),(this.options.enableReplying||this.options.enableUpvoting)&&(t.append(h),e.append(h.clone())),this.options.enableAttachments&&(t.append(u),i.append(u.clone())),this.options.forceResponsive&&this.forceResponsive(),r},createSpinner:function(){var i=n("<div/>",{"class":"spinner"}),t=n("<i/>",{"class":"fa fa-spinner fa-spin"});return this.options.spinnerIconURL.length&&(t.css("background-image",'url("'+this.options.spinnerIconURL+'")'),t.addClass("image")),i.html(t),i},createCommentElement:function(t){var i=n("<li/>",{"data-id":t.id,"class":"chat-comment"+(t.parent==null?" chat-comment-panel":"")}).data("model",t),r,u;return t.createdByCurrentUser&&i.addClass("by-current-user"),t.createdByAdmin&&i.addClass("by-admin"),r=n("<ul/>",{"class":"chat-child-comments"}),u=this.createCommentWrapperElement(t),i.append(u),t.parent==null&&i.append(r),i},createCommentWrapperElement:function(t){var tt=n("<div/>",{"class":"chat-comment-wrapper "+(t.parent==null?"main-chat-comment":"")}),lt=this.createProfilePictureElement(t.profilePictureURL,t.creator),at=n("<time/>",{text:this.options.timeFormatter(t.created),"data-original":t.created}),p=n("<span/>",{"data-user-id":t.creator,text:t.createdByCurrentUser?this.options.textFormatter(this.options.youText):t.fullname}),e,h,w,c,it,l,r,a,i,rt,ut,d,ft,g,v,y,nt,u,s,et,st,ht,ct;t.profileURL&&(p=n("<a/>",{href:t.profileURL,html:p}));e=n("<div/>",{"class":"name",html:p});t.createdByAdmin&&e.addClass("highlight-font-bold");t.parent&&(h=this.commentsById[t.parent],h.parent&&(w=n("<span/>",{"class":"reply-to",text:h.fullname,"data-user-id":h.creator}),c=n("<i/>",{"class":"fa fa-share"}),this.options.replyIconURL.length&&(c.css("background-image",'url("'+this.options.replyIconURL+'")'),c.addClass("image")),w.prepend(c),e.append(w)));t.isNew&&(it=n("<span/>",{"class":"new highlight-background",text:this.options.textFormatter(this.options.newText)}),e.append(it));var b=n("<div/>",{"class":"wrapper"}),o=n("<div/>",{"class":"content"}),k=t.fileURL!=undefined;k?(l=null,r=null,t.fileMimeType&&(a=t.fileMimeType.split("/"),a.length==2&&(l=a[1],r=a[0])),i=n("<a/>",{"class":"attachment",href:this.options.filePath+t.id,target:"_blank"}),r=="image"?(rt=n("<img/>",{src:this.options.filePath+t.id}),i.html(rt)):r=="video"?(ut=n("<video/>",{src:this.options.filePath+t.id,type:t.fileMimeType,controls:"controls"}),i.html(ut)):(d=this,ft=function(){d.options.downloadAttachment(t)},i=n("<a/>",{"class":"attachment",style:"cursor: pointer",target:"_blank",id:d.options.filePath+t.id,click:function(){ft()}}),g=["archive","audio","code","excel","image","movie","pdf","photo","picture","powerpoint","sound","video","word","zip"],v="fa fa-file-o",g.indexOf(l)>0?v="fa fa-file-"+l+"-o":g.indexOf(r)>0&&(v="fa fa-file-"+r+"-o"),y=n("<i/>",{"class":v}),this.options.fileIconURL.length&&(y.css("background-image",'url("'+this.options.fileIconURL+'")'),y.addClass("image")),nt=t.fileURL.split("/"),u=nt[nt.length-1],u=u.split("?")[0],u=decodeURIComponent(u),i.text(u),i.prepend(y)),o.html("<p class='comment-text'>"+this.highlightTags(t,this.linkify(this.escape(t.content)))+" <\/p>"),o.append(i)):o.html(this.getFormattedCommentContent(t));t.modified&&t.modified!=t.created&&(s=this.options.timeFormatter(t.modified),s!==null&&s!==""&&s.localeCompare("1/1/1")!==0&&(et=n("<time/>",{"class":"edited",text:this.options.textFormatter(this.options.editedText)+" "+s,"data-original":t.modified})),o.append(et));var f=n("<span/>",{"class":"actions"}),vt=n("<span/>",{"class":"separator",text:"¬∑"}),yt=n("<button/>",{"class":"action reply",type:"button",text:this.options.textFormatter(this.options.replyText)}),ot=n("<i/>",{"class":"fa fa-thumbs-up"});return this.options.upvoteIconURL.length&&(ot.css("background-image",'url("'+this.options.upvoteIconURL+'")'),ot.addClass("image")),st=this.createUpvoteElement(t),this.options.enableReplying&&f.append(yt),this.options.enableUpvoting&&f.append(st),(t.createdByCurrentUser||this.options.currentUserIsAdmin)&&(k&&t.createdByCurrentUser&&this.options.enableDeleting?(ht=n("<button/>",{"class":"action delete enabled",text:this.options.textFormatter(this.options.deleteText)}),f.append(ht)):!k&&t.createdByCurrentUser&&this.options.enableEditing&&(ct=n("<button/>",{"class":"action edit",text:this.options.textFormatter(this.options.editText)}),f.append(ct))),f.children().each(function(t,i){n(i).is(":last-child")||n(i).after(vt.clone())}),b.append(o),b.append(f),tt.append(lt).append(at).append(e).append(b),tt},createUpvoteElement:function(t){var i=n("<i/>",{"class":"fa fa-thumbs-up"});return this.options.upvoteIconURL.length&&(i.css("background-image",'url("'+this.options.upvoteIconURL+'")'),i.addClass("image")),n("<button/>",{"class":"action upvote"+(t.userHasUpvoted?" highlight-font":"")}).append(n("<span/>",{text:t.upvoteCount,"class":"upvote-count"})).append(i)},createTagElement:function(t,i,r,u){var f=n("<input/>",{"class":"tag",type:"button","data-role":"none"});return i&&f.addClass(i),f.val(t),f.attr("data-value",r),u&&f.attr(u),f},reRenderComment:function(t){var i=this.commentsById[t],r=this.$el.find('li.chat-comment[data-id="'+i.id+'"]'),u=this;r.each(function(t,r){var f=u.createCommentWrapperElement(i);n(r).find(".chat-comment-wrapper").first().replaceWith(f)})},reRenderCommentActionBar:function(t){var i=this.commentsById[t],r=this.$el.find('li.chat-comment[data-id="'+i.id+'"]'),u=this;r.each(function(t,r){var f=u.createCommentWrapperElement(i);n(r).find(".actions").first().replaceWith(f.find(".actions"))})},reRenderUpvotes:function(t){var i=this.commentsById[t],r=this.$el.find('li.chat-comment[data-id="'+i.id+'"]'),u=this;r.each(function(t,r){var f=u.createUpvoteElement(i);n(r).find(".upvote").first().replaceWith(f)})},createCssDeclarations:function(){n("head style.jquery-chat-comments-css").remove();this.createCss(".jquery-chat-comments ul.navigation li.active:after {background: "+this.options.highlightColor+" !important;",+'}');this.createCss(".jquery-chat-comments ul.navigation ul.dropdown li.active {background: "+this.options.highlightColor+" !important;",+'}');this.createCss(".jquery-chat-comments .highlight-background {background: "+this.options.highlightColor+" !important;",+'}');this.createCss(".jquery-chat-comments .highlight-font {color: "+this.options.highlightColor+" !important;}");this.createCss(".jquery-chat-comments .highlight-font-bold {color: "+this.options.highlightColor+" !important;font-weight: bold;}")},createCss:function(t){var i=n("<style/>",{type:"text/css","class":"jquery-chat-comments-css",text:t});n("head").append(i)},getComments:function(){var n=this;return Object.keys(this.commentsById).map(function(t){return n.commentsById[t]})},getUsers:function(){var n=this;return Object.keys(this.usersById).map(function(t){return n.usersById[t]})},getChildComments:function(n){return this.getComments().filter(function(t){return t.parent==n})},getAttachments:function(){return this.getComments().filter(function(n){return n.fileURL!=undefined})},getOutermostParent:function(n){var i=n,t;do t=this.commentsById[i],i=t.parent;while(t.parent!=null);return t},createCommentJSON:function(n){var t=(new Date).toISOString();return{id:"c"+(this.getComments().length+1),parent:n.attr("data-parent")||null,created:t,modified:t,content:this.getTextareaContent(n),pings:this.getPings(n),fullname:this.options.textFormatter(this.options.youText),profilePictureURL:this.options.profilePictureURL,createdByCurrentUser:!0,upvoteCount:0,userHasUpvoted:!1}},isAllowedToDelete:function(t){if(this.options.enableDeleting){var i=!0;return this.options.enableDeletingCommentWithReplies||n(this.getComments()).each(function(n,r){r.parent==t&&(i=!1)}),i}return!1},setToggleAllButtonText:function(n,t){var u=this,i=n.find("span.text"),e=n.find(".caret"),f=function(){var t=u.options.textFormatter(u.options.viewAllRepliesText),r=n.siblings(".chat-comment").length;t=t.replace("__replyCount__",r);i.text(t)},r=this.options.textFormatter(this.options.hideRepliesText);t?(i.text()==r?f():i.text(r),e.toggleClass("up")):i.text()!=r&&f()},adjustTextareaHeight:function(t,i){var e=2.2,o=1.45,s=function(n){var i=e+(n-1)*o;t.css("height",i+"em")},r,u,f;t=n(t);r=i==!0?this.options.textareaRowsOnFocus:this.options.textareaRows;do s(r),r++,u=t[0].scrollHeight>t.outerHeight(),f=this.options.textareaMaxRows==!1?!1:r>this.options.textareaMaxRows;while(u&&!f)},clearTextarea:function(n){n.empty().trigger("input")},getTextareaContent:function(t,i){var r=t.clone(),u;return r.find(".reply-to.tag").remove(),r.find(".tag.hashtag").replaceWith(function(){return i?n(this).val():"#"+n(this).attr("data-value")}),r.find(".tag.ping").replaceWith(function(){return i?n(this).val():"@"+n(this).attr("data-value")}),u=r.text().replace(/^\s+/g,""),u=this.normalizeSpaces(u),u},getFormattedCommentContent:function(n,t){var i=this.escape(n.content);return i=this.linkify(i),i=this.highlightTags(n,i),t&&(i=i.replace(/(?:\n)/g,"<br>")),i},getPings:function(t){return n.map(t.find(".ping"),function(t){return parseInt(n(t).attr("data-value"))})},moveCursorToEnd:function(t){var i,u,r;t=n(t)[0];n(t).trigger("input");n(t).scrollTop(t.scrollHeight);typeof getSelection!="undefined"&&typeof document.createRange!="undefined"?(i=document.createRange(),i.selectNodeContents(t),i.collapse(!1),u=window.getSelection(),u.removeAllRanges(),u.addRange(i)):typeof document.body.createTextRange!="undefined"&&(r=document.body.createTextRange(),r.moveToElementText(t),r.collapse(!1),r.select());t.focus()},escape:function(t){return n("<pre/>").text(this.normalizeSpaces(t)).html()},normalizeSpaces:function(n){if(n!=undefined)return n.replace(new RegExp("¬†","g")," ")},after:function(n,t){var i=this;return function(){return n--,n==0?t.apply(i,arguments):void 0}},highlightTags:function(n,t){return this.options.enableHashtags&&(t=this.highlightHashtags(n,t)),this.options.enablePinging&&(t=this.highlightPings(n,t)),t},highlightHashtags:function(n,t){var u=this,i,r;return t.indexOf("#")!=-1&&(i=function(n){var n=u.createTagElement("#"+n,"hashtag",n);return n[0].outerHTML},r=/(^|\s)#([a-zÿß-Ÿä ÿ£Ÿâ √§√∂√º√ü\d-_]+)/gim,t=t.replace(r,function(n,t,r){return t+i(r)})),t},highlightPings:function(t,i){var r=this,f,u;return i.indexOf("@")!=-1?(f=function(n){var t=r.createTagElement("@"+n.fullname,"ping",n.id,{"data-user-id":n.id});return t[0].outerHTML},u="",n(t.pings).each(function(n,t){if(t in r.usersById){var o=r.usersById[t],e="@"+o.fullname,s=i.indexOf(e)+e.length,h=i.slice(0,s);u+=h.replace(e,f(o));i=i.slice(s)}}),u+=i):i},linkify:function(n){var t,u,f,e,o,i,r;if(u=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,t=n.replace(u,'<a href="$1" target="_blank">$1<\/a>'),f=/(^|[^\/f])(www\.[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,t=t.replace(f,'$1<a href="http://$2" target="_blank">$2<\/a>'),e=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,t=t.replace(e,'<a href="mailto:$1">$1<\/a>'),o=n.match(/<a href/g)||[],o.length>0){for(i=n.split(/(<\/a>)/g),r=0;r<i.length;r++)i[r].match(/<a href/g)==null&&(i[r]=i[r].replace(u,'<a href="$1" target="_blank">$1<\/a>').replace(f,'$1<a href="http://$2" target="_blank">$2<\/a>').replace(e,'<a href="mailto:$1">$1<\/a>'));return i.join("")}return t},waitUntil:function(n,t){var i=this;n()?t():setTimeout(function(){i.waitUntil(n,t)},100)},applyInternalMappings:function(n){var r={},t=this.options.fieldMappings;for(var i in t)t.hasOwnProperty(i)&&(r[t[i]]=i);return this.applyMappings(r,n)},applyExternalMappings:function(n){var t=this.options.fieldMappings;return this.applyMappings(t,n)},applyMappings:function(n,t){var r={},i,u;for(i in t)i in n&&(u=n[i],r[u]=t[i]);return r}};n.fn.chatComments=function(i){var r=Object.create(t);return n.data(this,"chatComments",r),r.init(i||{},this),r}});